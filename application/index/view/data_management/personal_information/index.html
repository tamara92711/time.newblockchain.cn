{extend name="/common/templates/tpl-w-sb"} {block name="page-title"}个人信息{/block} {block name="custom-css"}
<link rel="stylesheet" href="/assets/css/index/index/personal_info.css"> {/block} {block name="main-part"}
<div>
    <div class="qk-portlet" style="margin-top:1px;width: 940px;margin-left:-2px">
        <div class="qk-portlet-title">
            <img class="qk-portlet-title-icon" src="/assets/img/personal.png" />
            <span class="qk-portlet-title-text">个人信息</span>
        </div>
        <div class="qk-portlet-content form" style="height: 791px">
            <form id="personal_form" class="form-horizontal">
                <div class="form-group">
                    <div class="left">
                        <label for="username">用户名：</label>
                    </div>
                    <div class="right">
                        <input type="text" class="form-control" name="username" id="username" readonly="readonly" value="{$user_data[0]['name']}"/>
                    </div>
                    <label class="error" for="username" id="username_error">这是必填栏。</label>
                </div>

                <div class="form-group">
                    <div class="left">
                        <label>真实姓名：</label>
                    </div>
                    <div class="right">
                        <input type="text" class="form-control" name="realname" id="realname" value="{$user_real_name}" readonly/>
                    </div>
                    <label class="error" for="realname" id="realname_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>性别:</label>
                    </div>
                    <div class="right">
                        <div class="radio radio-danger">
                            <input type="radio" name="gender" id="male" value="1">
                            <label for="male">
                                男
                            </label>
                        </div>
                        <div class="radio radio-danger">
                            <input type="radio" name="gender" id="female" value="2">
                            <label for="female">
                                女
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>旧密码：</label>
                    </div>
                    <div class="right">
                        <input type="password" class="form-control" name="beforepass" id="beforepass" />
                    </div>
                    <label class="error" for="beforepass" id="beforepass_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>新密码：</label>
                    </div>
                    <div class="right">
                        <input type="password" class="form-control" name="newpass" id="newpass" />
                    </div>
                    <label class="error" for="newpass" id="newpass_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>确认密码：</label>
                    </div>
                    <div class="right">
                        <input type="password" class="form-control" name="verifypass" id="verifypass" />
                    </div>
                    <label class="error" for="verifypass" id="verifypass_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>职业：</label>
                    </div>
                    <div class="right">
                        <select class="form-control" style="height:36px" id="occupation" name="occupation">
                            {foreach :model('EducationType')->all() as $key=>$val }
                            <option value="{$val.id}">{$val.name}</option>
                            {/foreach}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>学历：</label>
                    </div>
                    <div class="right">
                        <select class="form-control" style="height:36px" id="education" name="education">
                            {foreach :model('JobType')->all() as $key=>$val }
                            <option value="{$val.id}">{$val.name}</option>
                            {/foreach}
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <div class="left">
                        <label>手机号码：</label>
                    </div>
                    <div class="right">
                        <input type="number" class="form-control" style="width:200px;float:left;margin-right:10px" id="cellphone" name="cellphone"
                               readonly="readonly" value="{$user_data[0]['mobile']}" />
                        <a href="#changePhoneNumber" role="button" class="btn" data-toggle="modal" style="float:left;width:90px;background-color:#ff5656;margin-top:-6px;height:36px;border-radius:0px">
                            修改手机 </a>
                    </div>
                    <label class="error" for="cellphone" id="cellphone_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>固定电话：</label>
                    </div>
                    <div class="right">
                        <input type="text" class="form-control" id="fixed" name="fixed" value="{$user_fixed}"  />
                    </div>
                    <label class="error" for="fixed" id="fixed_error">这是必填栏。</label>
                </div>
                <div class="form-group">
                    <div class="left">
                        <label>E-mail：</label>
                    </div>
                    <div class="right">
                        <input type="email" class="form-control" id="email" name="email" value="{$user_email}" />
                    </div>
                    <label class="error" for="email" id="email_error">这是必填栏。</label>
                </div>
                <div class="form-group" style="padding-top:11px;border-bottom: none; margin-bottom: 14px;">
                    <div class="left" style="height:1px">
                    </div>
                    <div class="right">
                        <button class="btn" style="margin-right:15px;background-color:#ff5656" id="save">保存</button>
                        <button class="btn" style="background-color:#ffc750" onclick="returnHome();">返回</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="changePhoneNumber" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="changePhoneNumberLabel" aria-hidden="true"
     style="display: none;">
    <div class="modal-dialog container" style="width:452px;margin-top:200px">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
            </div>
            <div class="modal-body" style="padding-bottom:34px">
                <div class="container login-title" style="border-top: 1px solid #ff5656;width: 330px;margin-top: 2px;margin-bottom:15px;">
                    <p style="font-family: ms-yahei-bold;color: #ff5656;font-size: 18px;margin-top: -15px;margin-bottom:0px;background-color: white;width: 111px;margin-left: 109px;padding-left: 20px;padding-right: 0px;">修改手机</p>
                </div>
                <label class="error" for="email" id="verifyError" style="margin-left: 0px;">这是必填栏。</label>
                <div class="form">
                    <form role="form">
                        <div class="form-group">
                            <div class="left">
                                <label>手机号码：</label>
                            </div>
                            <div class="right">
                                <input type="number" class="form-control" id="old_mobile" readonly="readonly" value="{$user_data[0]['mobile']}" />
                            </div>
                            <div class="error"></div>
                        </div>
                        <div class="form-group">
                            <div class="left">
                                <label>手机验证：</label>
                            </div>
                            <div class="right">
                                <div class="input-group">
                                    <input type="number" class="form-control" style="width:190px;" id="oldMobileVerifyCode" oninput="if(value.length>4)value=value.slice(0,4)">
                                    <span class="input-group-btn">
                                        <!-- <button class="btn" type="button" onclick="create_phone_verify_code(1);">获取验证码</button> -->
                                        <input type="button" onclick="create_phone_verify_code(1)" class="btn get-veri-code-btn" id="oldMobileVerifyCodeButton" value="获取验证码" style="width: 90px;height: 32px;margin-top: -6px;border-top-left-radius: 0px;border-bottom-left-radius: 0px;padding:0px 5px" />
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="left">
                                <label>新手机号：</label>
                            </div>
                            <div class="right">
                                <input type="number" class="form-control" id="new_mobile" oninput="if(value.length>11)value=value.slice(0,11)" readonly="readonly"
                                />
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="left">
                                <label>手机验证：</label>
                            </div>
                            <div class="right">
                                <div class="input-group">
                                    <input type="number" class="form-control" style="width:190px;" id="newMobileVerifyCode" oninput="if(value.length>4)value=value.slice(0,4)">
                                    <span class="input-group-btn">
                                        <!-- <button class="btn" type="button" onclick="create_phone_verify_code(2);" id="newMobileVerifyCodeButton">获取验证码</button> -->
                                        <input type="button" onclick="create_phone_verify_code(2)" class="btn get-veri-code-btn" id="newMobileVerifyCodeButton" value="获取验证码" style="width: 90px;height: 32px;margin-top: -6px;border-top-left-radius: 0px;border-bottom-left-radius: 0px;padding:0px 5px"/>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="left" style="height:1px">
                            </div>
                            <div class="right">
                                <button type="button" class="btn" id="changePhoneButton" onclick="javascript:onModalOK();" style="background-color: #ff5656;color: white;height: 40px;width: 200px;padding-left: 11px;padding-top: 7px;font-size: 18px;">确认新增</button>
                            </div>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

{/block} {block name="custom-js"}
<script type="text/javascript" src="/assets/js/common/common.js"></script>

<script>
    $(document).ready(function () {
        $('.error').hide();
        $("input#username").focus();
        $("#occupation").val("{$user_data[0]['job_type']}");
        $("#education").val("{$user_data[0]['education_type']}");
        $("input[name=gender][value={$user_data[0]['sex']}]").prop("checked", true);

        var readonly = $("new_mobile").attr("readonly");


    })

    $("#personal_form").submit(function (e) {
        e.preventDefault();
        if (($("#beforepass").val().length >= 1) && ($("#newpass").val().length >= 1) && ($("#verifypass").val().length >= 1))
        {
            validation(2);
            // if(!result) return;
        }
        else
        {
            validation(1);
            // console.log(result);
            // if(!result) return;
        }


        var formData = $(this).serialize();
        $.ajax({
            url: "/personal_update",
            method: 'POST',
            data: formData,
            success: function (result) {

                if (result == 'ok') {
                    $.alert({
                        title: '确认',
                        content: '个人信息已成功保存!',
                    });
                }
                else if (result == "failure")
                {
                    $.alert({
                        title :'确认',
                        content : '您的旧密码错误，请正确输入密码！',
                    });
                    $("input#beforepass").focus();
                }

            }
        });


    });
    //when modal diaolg show at first confirm and verifycode button disable
    $("#changePhoneButton").attr('disabled', 'disabled').addClass('ui-state-disabled');
    $("#newMobileVerifyCodeButton").attr('disabled', 'disabled').addClass('ui-state-disabled');

    $("#oldMobileVerifyCode").on('keyup blur', function () {
        var oldMobileVerifyCode = $(this).val();

        var isnum = /^\d+$/.test(oldMobileVerifyCode);
        if (!isnum || oldMobileVerifyCode.length != 4) {
            $(this).focus();
        }

        else if (isnum || oldMobileVerifyCode.length == 4) {
            // {console.log("old="+oldMobileVerifyCode);
            $.ajax({
                url: '/confirmOldMobileVerifyCode',
                method: "post",
                data: { oldMobileVerifyCode: oldMobileVerifyCode },
                success: function (result) {
                    if (result == "wrong") {
                        $("#verifyError").text("验证旧手机号码是错误的。").show();
                    }
                    else if (result == "ok") {
                        $("#verifyError").hide();
                        $("#new_mobile").removeAttr("readonly");
                        $("#new_mobile").focus();
                    }
                }
            });
        }
    });

    $("#newMobileVerifyCode").on('keyup blur', function () {
        var newMobileVerifyCode = $(this).val();

        var isnum = /^\d+$/.test(newMobileVerifyCode);
        if (!isnum || newMobileVerifyCode.length != 4) {
            $(this).focus();
        }
        else if (isnum || newMobileVerifyCode.length == 4) {
            // {console.log("new="+newMobileVerifyCode);
            $.ajax({
                url: '/confirmNewMobileVerifyCode',
                method: "post",
                data: { newMobileVerifyCode: newMobileVerifyCode },
                success: function (result) {
                    if (result == "wrong") {
                        $("#verifyError").text("验证新手机号码是否有误。").show();
                    }
                    else if (result == "ok") {
                        $("#verifyError").hide();
                        $("#changePhoneButton").removeAttr("disabled");
                    }
                }
            });
        }
    });

    $("#new_mobile").on('keyup blur', function () {
        var new_mobile = $(this).val();

        var isnum = /^\d+$/.test(new_mobile);
        if (!isnum || new_mobile.length != 11) {
            $(this).focus();
        }
        else if (isnum || new_mobile.length == 11) {
            $.ajax({
                url: '/existMobile',
                method: "post",
                data: { new_mobile: new_mobile },
                success: function (result) {
                    if (result == "exist") {
                        $("#verifyError").text("这个手机号码已经被注册。").show();

                    }
                    else if (result == "not exist") {
                        $("#verifyError").hide();
                        $("#newMobileVerifyCodeButton").removeAttr("disabled");
                    }
                }
            })
        }
    });

    function create_phone_verify_code(mode) {

        if (mode == 1) {
            var old_mobile = $("#old_mobile").val();
            var dataString = { phone_number: old_mobile, mode: 1 };
        }
        else if (mode == 2) {
            var new_mobile = $("#new_mobile").val();
            var dataString = { phone_number: new_mobile, mode: 2 };
        }

        $.ajax({
            url: '/phoneChangeVerifyCode',
            method: "post",
            data: dataString,
            success: function (response) {
                result = JSON.parse(response);
                if (result.error) {
                    // console.log("" + mode + "-code:" + result.code);
                    // console.log("" + mode + "-text:" + result.text);
                    // $("#new_mobile").focus();
                } else {
                    // console.log("" + mode + "-code:" + result.code);
                    // console.log("" + mode + "-text:" + result.text);
                    if (mode == 1) {
                        time($("#oldMobileVerifyCodeButton"), 60);
                    }
                    if (mode == 2) {
                        time($("#newMobileVerifyCodeButton"), 60);
                    }
                }
            }
        });
    }

    function onModalOK() {
        $("#changePhoneNumber").modal('hide');
        $("#cellphone").val($("#new_mobile").val());

    }

    function returnHome() {
        window.location.href = "/index/service_management.release_requirement";
    }

    // //email check
    // function isValidEmailAddress(email) {
    //     var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    //     return regex.test(email);
    // }


    $("#fixed").keypress(function (event) {
        var code = event.which;
        if (code < 48 || code > 57) event.preventDefault();
        else $("#fixed_error").text('input enter number').show();
    });

    function tempValidation_1(mode) {
        $('.error').hide();
        var username = $("input#username").val();
        if (username == "") { //user name
            $("label#username_error").show();
            $("input#username").focus();
            return false;
        }
        var realname = $("input#realname").val();
        if (realname == "") {
            $("label#realname_error").show();
            $("input#realname").focus();
            return false;
        }
        var cellphone = $("input#cellphone").val();
        if (cellphone == "") {
            $("label#cellphone_error").show();
            $("input#cellphone").focus();
            return false;
        }
        return true;
    }


    function tempValidation_2() {
        var beforepass = $("input#beforepass").val();
        if (beforepass == "") {
            $("label#beforepass_error").show();
            $("input#beforepass").focus();
            return false;
        }
        var newpass = $("input#newpass").val();
        if (newpass == "") {
            $("label#newpass_error").show();
            $("input#newpass").focus();
            return false;
        }
        var verifypass = $("input#verifypass").val();
        if (verifypass == "") {
            $("label#verifypass_error").show();
            $("input#verifypass").focus();
            return false;
        }
        if (newpass !== verifypass) {
            $("label#verifypass_error").text("密码不一样");
            $("label#verifypass_error").show();
            $("input#verifypass").focus();
            return false;
        }
        // console.log("mode2");
        return true;
    }

    function validation(mode) {
        if (mode == 1)
        {
            console.log("1");
            tempValidation_1();
        }
        else if (mode == 2)
        {
            tempValidation_1() && tempValidation_2();
        }
    }
    $("#beforepass,#newpass,#verifypass,#email,#fixed").keypress(function () {
        $("label#beforepass_error").hide();
        $("label#newpass_error").hide();
        $("label#verifypass_error").hide();
        $("label#email_error").hide();
        $("label#fixed_error").hide();

    })
</script>
{/block}
