{extend name="/common/templates/tpl-wo-sb"}

{block name="page-title"}购买界面{/block}
{block name="main"}
<div>
    <div class="qk-portlet-title" style="margin-top: 9px;">
        <span class="qk-portlet-title-text">收货人信息</span>
        <a href="#" id="new_shipping_address" data-toggle="modal" data-keyboard="false">新增收货地址</a>
    </div>
    <div class="qk-portlet-content">
        <?php
         foreach ($addresses as $key=>$address) { ?>
        <div class="rows">
            <div class="user-item">
                <input  type="radio" name="userlist" id="userlist_{$address['id']}"
                    value="'+item.user_id+'"
                    onclick="select_to_user({$address['id']})">
                <label for="userlist_{$address['id']}"></label>
            </div>
            <div class="left first-spacing" id="address_name_{$address['id']}">{$address['name']}</div>
            <div class="left pr54" id="address_detail_{$address['id']}">{$address['detail']}</div>
            <div class="left" id="address_phone_{$address['id']}">{$address['phone']}</div>
        </div>
        <?php } ?>
    </div>

    <div class="qk-portlet-title" style="margin-top: 5px;">
        <span class="qk-portlet-title-text">支付方式</span>
    </div>
    <div class="qk-portlet-content">
        <div class="rows" style="border-bottom: none;">
            <div class="payment_types">
                <input id="wechat" class="radio-inline__input" type="radio" name="accessible-radio" value="item-1" onclick="set_paymentMethod()">
                <label class="radio-inline__label" for="wechat">
                    <img src="/assets/img/shijianfei.png" style="padding-right: 17px;"/>时间币支付
                </label>
                <img class="tick-img" src="/assets/img/corner-tick.png">
            </div>
            <div style="margin-top:14px; color:green;font-size: 16px" id="coin_amount"></div>
        </div>
        <div class="rows" id="cant_purchase" style="display: none;">
            <a href="/index/time_money/buy" style="color:red">温馨提示：您的时间币余额不足，需充值后才能提交并结算订单！</a>
        </div>
    </div>

    <div class="qk-portlet-title" style="margin-top: 29px;">
        <span class="qk-portlet-title-text">订单清单</span>
    </div>
    <div class="qk-portlet-content">
        <div class="table-heads" style="border-bottom: 1px dotted #ff5656; font-size: 15px;">
            <div class="left br-red-grey font-b" style="padding-left: 63px; padding-right: 65px;">序号</div>
            <div class="left br-red-grey font-b" style="padding-left: 280px; padding-right: 285px;">商品名称</div>
            <div class="left br-red-grey font-b" style="padding-left: 64px; padding-right: 68px;">单价</div>
            <div class="left br-red-grey font-b" style="padding-left: 62px;">数量</div>
        </div>
        <div class="clearfix"></div>
        <?php $sum = 0;
        for($i = 0 ; $i < sizeof($products); $i++){ ?>
        <div class="rows" style="font-size: 15px;">
            <div class="left" style="padding-top:4px;padding-left: 53px;">{$i+1}</div>
            <div class="left" style="padding-top:2px;padding-left: 195px;">{$products[$i]->description}</div>
            <div class="left" style="padding-top:2px;padding-left: 199px; color: red;">{$products[$i]->price}</div>
            <div class="left" style="padding-top:2px;padding-left: 142px;">{$products[$i]->amount}</div>
        </div>
        <?php 
            $sum += $products[$i]->price * $products[$i]->amount;
        }?>
    </div>
    <form action="/order_now" method="post">
    <input type="hidden" name="ids" value={$product_ids}/>
    <div style="margin-top: 56px;font-family: ms-yahei-bold;margin-bottom: 8px;">订单备注：</div>
    <textarea class="form-control"  placeholder="请输入你需要备注的内容..." name="comment" id="comment" style="height: 100px; width: 100%;"></textarea>
    <div class="product-row">
        <p class="right">
            <span>应付金额：</span>
            <span id="total_cost">{$sum}</span>
        </p>
        <div class="clearfix"></div>
        <div class="p-row">
            <input type="hidden" name="address" id="address"/>
            <div class="product-third" id="final_user_phone"></div>
            <div class="product-second" id="final_user_address"></div>
            <div class="product-first" id="final_user_name"></div>
        </div>
    </div>
    <div class="clearfix"></div>
    <div class="rows" style=" margin: 0px; padding: 0px;  padding-bottom: 0px;">
        <button id="order" type="submit" disabled class="btn  button-submit-order" >提交订单</button>
    </div>
    </form>
</div>

{/block}
{block name="custom-css"}
<link href="/assets/css/index/index/purchase_interface.css" rel="stylesheet" type="text/css" />
{/block}
{block name="custom-js"}
<script>
function select_to_user(id)
{
    console.log(id);
    $("#final_user_phone").html($("#address_phone_"+id).html());
    $("#final_user_address").html($("#address_detail_" + id).html());
    $("#final_user_name").html($("#address_name_" + id).html());
    $("#address").val(id);
    refresh_button();
}

function set_paymentMethod()
{
    $.ajax({
        url: "/get_balance",
        method: 'get',
        success: function (res) {
            $("#coin_amount").html('(可用余额:'+res+')');
            var balance = parseFloat(res);
            var total = parseInt($("#total_cost").html());
            if (balance < total) {
                $("#cant_purchase").show();
                refresh_button();
            }
            else{
                $("#cant_purchase").hide();
                refresh_button();
            }
        }
    })
}

function refresh_button ()
{
    if ($("#cant_purchase").is(":visible") == false && $("#address").val() != "")
    {
        $("#order").attr("disabled", false);
    }
    else{
        $("#order").attr("disabled", true);
    }
}

</script>
{/block}